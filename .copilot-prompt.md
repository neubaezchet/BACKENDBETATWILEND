# ğŸ”§ Arreglador de IntegraciÃ³n n8n-WAHA

## PROBLEMA CRÃTICO âŒ
El backend enviaba solicitudes a n8n, pero NO LLEGABAN EMAILS NI MENSAJES DE WHATSAPP durante varios deploys.

## CAUSA RAÃZ IDENTIFICADA ğŸ”
1. **Workflow N8N**: El nodo "WAHA - Enviar WhatsApp" NO tenÃ­a los headers de API Key configurados
   - URL: `https://devlikeaprowaha-production-111a.up.railway.app/api/sendText`
   - Header faltante: `X-API-Key: 1085043374`
   - Content-Type faltante: `application/json`

2. **Backend N8N Notifier**: Sin logging detallado sobre quÃ© pasÃ³ con la respuesta de n8n

3. **Sin health checks**: El backend no verificaba si n8n estaba disponible antes de enviar

## SOLUCIÃ“N IMPLEMENTADA âœ…

### 1. Workflow N8N (JSON) - CORREGIDO
- âœ… Agregados headers correctos al nodo WAHA
- âœ… X-API-Key: 1085043374
- âœ… Content-Type: application/json
- âœ… Timeout: 30 segundos

### 2. Backend n8n_notifier.py - MEJORADO
- âœ… Logging detallado de CADA paso
- âœ… ValidaciÃ³n de response.status_code (200, 201, 202, 204)
- âœ… Parsing de respuesta JSON para detectar si EMAIL/WHATSAPP se enviaron
- âœ… Tolerancia a timeouts (asumiendo que se envÃ­an en background)
- âœ… FunciÃ³n `verificar_salud_n8n()` para health checks
- âœ… User-Agent identificador en headers

### 3. Flujo de DepuraciÃ³n Nuevo
```
Backend envÃ­a â†’ n8n recibe â†’ Procesa Datos â†’ Email (Gmail) â†’ Respuesta
                                          â†“
                        Â¿Enviar WhatsApp? (IF)
                                          â†“
                        Split Numbers â†’ WAHA API â†’ Respuesta
                                          â†“
                        Preparar Respuesta â†’ Respond to Webhook
```

## CÃ“MO VERIFICAR QUE FUNCIONA âœ…

### Test 1: Health Check del Backend
```bash
curl -X GET http://localhost:8000/health
# DeberÃ­a responder 200 OK
```

### Test 2: Enviar solicitud de prueba
```bash
curl -X POST https://railway-n8n-production-5a3f.up.railway.app/webhook/incapacidades \
  -H "Content-Type: application/json" \
  -d '{
    "tipo_notificacion": "confirmacion",
    "email": "tumail@gmail.com",
    "serial": "TEST-001",
    "subject": "Test desde backend",
    "html_content": "<p>Prueba de envÃ­o</p>",
    "cc_email": "",
    "correo_bd": "",
    "whatsapp": "573208757593",
    "whatsapp_message": "Mensaje de prueba desde test",
    "adjuntos": []
  }'
```

### Test 3: Revisar en N8N Dashboard
1. Ve a: https://railway-n8n-production-5a3f.up.railway.app
2. Credenciales: `admin / 1085043374@Aa`
3. Abre workflow "IncaNeurobaeza - Email + WhatsApp v5"
4. Ve a "Executions" (Ãºltimas ejecuciones)
5. Busca la que acabas de disparar (timestamp reciente)
6. Verifica que TODOS los nodos estÃ©n en VERDE:
   - âœ… Webhook (recibiÃ³ datos)
   - âœ… Procesar Datos (procesÃ³ correctamente)
   - âœ… Gmail Sender (enviÃ³ email)
   - âœ… WAHA - Enviar WhatsApp (enviÃ³ WhatsApp)
   - âœ… Preparar Respuesta (armÃ³ respuesta)
   - âœ… Respond to Webhook (respondiÃ³ al backend)

### Test 4: Backend logs en Railway
1. Ve a consola de Railway: https://railway.app
2. Proyecto: `railway-backend`
3. Abre "Logs" (Ãºltimos 100)
4. Busca lÃ­neas de `n8n_notifier.py`
5. DeberÃ­as ver:
   ```
   ğŸ“¤ Enviando a n8n: https://railway-n8n-production-5a3f.up.railway.app/webhook/incapacidades
   âœ… n8n respondiÃ³ OK (status 200)
   âœ… EMAIL enviado: tumail@gmail.com
   âœ… WHATSAPP enviado:
      - NÃºmeros: ['573208757593@c.us']
      - Exitosos: 1/1
   ```

## ARCHIVOS EDITADOS ğŸ“
- âœ… `railway-n8n/wordflok/IncaNeurobaeza - Email + WhatsApp v5 (1).json` (headers WAHA)
- âœ… `app/n8n_notifier.py` (logging detallado, parsing respuesta, health check)

## PRÃ“XIMOS PASOS ğŸš€
1. Commitear cambios a GitHub
2. Pushear a railway-n8n (automatic deploy)
3. Ejecutar test #2 para verificar
4. Monitorear N8N Dashboard (ver ejecuciones)
5. Confirmar que emails y WhatsApp llegan

## VARIABLES DE ENTORNO CRÃTICAS ğŸ”
- `N8N_WEBHOOK_URL`: https://railway-n8n-production-5a3f.up.railway.app/webhook/incapacidades
- `WAHA_API_KEY`: 1085043374 (en N8N, no en backend)
- `WAHA_URL`: https://devlikeaprowaha-production-111a.up.railway.app

## SI SIGUE SIN FUNCIONAR ğŸ”§
1. Verifica que la sesiÃ³n WAHA siga en estado "WORKING"
   ```bash
   curl -X GET https://devlikeaprowaha-production-111a.up.railway.app/api/sessions \
     -H "X-API-Key: 1085043374"
   ```

2. Si dice "STOPPED", escanea el QR nuevamente

3. Si el email tampoco llega, verifica credenciales Gmail en N8N

4. Revisa logs de N8N: Dashboard â†’ Logs (arriba a la derecha)

## CONTACTO / ESCALACIÃ“N
- N8N Dashboard: https://railway-n8n-production-5a3f.up.railway.app (admin / 1085043374@Aa)
- WAHA Health: https://devlikeaprowaha-production-111a.up.railway.app/api/health
- Backend Logs: Railway console â†’ railway-backend â†’ Logs
