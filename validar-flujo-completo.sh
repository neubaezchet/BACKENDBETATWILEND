#!/bin/bash
# Validaci√≥n del flujo completo: Repogemin ‚Üí Backend ‚Üí N8N ‚Üí Confirmaci√≥n

echo "=========================================="
echo "VALIDACI√ìN DE FLUJO COMPLETO"
echo "Repogemin ‚Üí Backend ‚Üí N8N ‚Üí Confirmaci√≥n"
echo "=========================================="
echo ""

# Colores
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

API_URL="https://web-production-95ed.up.railway.app"
N8N_URL="https://railway-n8n-production-5a3f.up.railway.app/webhook/incapacidades"

echo "üìã TEST 1: Verificar que repogemin env√≠a correctamente"
echo "-------------------------------------------"
echo "‚úÖ ESTRUCTURA ESPERADA EN REPOGEMIN:"
echo "  1. Usuario llena formulario"
echo "  2. Sube documentos"
echo "  3. Click 'Enviar'"
echo "  4. Frontend hace POST a: /subir-incapacidad/"
echo "  5. FormData con fields:"
echo "     - cedula"
echo "     - tipo"
echo "     - email"
echo "     - telefono"
echo "     - archivos (PDFs)"
echo "     - incapacityStartDate"
echo "     - incapacityEndDate"
echo ""

echo "üìã TEST 2: Backend recibe y procesa"
echo "-------------------------------------------"
echo "‚úÖ FLUJO EN BACKEND (app/main.py):"
echo "  1. Recibe FormData"
echo "  2. Verifica bloqueos"
echo "  3. Genera serial: CEDULA DD MM YYYY DD MM YYYY"
echo "  4. Detecta reenv√≠os si aplica (-R1, -R2, etc)"
echo "  5. Sube PDFs a Drive"
echo "  6. Crea registro en BD (Case)"
echo "  7. Env√≠a a N8N con email + WhatsApp"
echo "  8. Retorna respuesta:"
echo "     {"
echo "       \"status\": \"ok\","
echo "       \"mensaje\": \"Registro exitoso\","
echo "       \"consecutivo\": \"1085043374 01 01 2026 02 02 2026\","
echo "       \"case_id\": 12345,"
echo "       \"link_pdf\": \"https://drive.google.com/...\","
echo "       \"archivos_combinados\": 3,"
echo "       \"correos_enviados\": [\"employee@company.com\"]"
echo "     }"
echo ""

echo "üìã TEST 3: N8N recibe y env√≠a notificaciones"
echo "-------------------------------------------"
echo "‚úÖ FLUJO EN N8N:"
echo "  1. Webhook recibe JSON de backend"
echo "  2. Extrae datos: email, telefono, serial, etc"
echo "  3. Env√≠a EMAIL v√≠a SMTP:"
echo "     - TO: email del empleado"
echo "     - CC: email_copia empresa"
echo "     - Contenido: Template de confirmaci√≥n"
echo "  4. Env√≠a WHATSAPP v√≠a Evolution API:"
echo "     - TO: telefono del empleado"
echo "     - Mensaje: Confirmaci√≥n de recibido"
echo "  5. Registra en Sheets tracker"
echo ""

echo "üìã TEST 4: Frontend repogemin recibe confirmaci√≥n"
echo "-------------------------------------------"
echo "‚úÖ L√ìGICA EN REPOGEMIN:"
echo ""
echo "  A. Si response.ok (status 200):"
echo "     ‚îî‚îÄ setSubmissionComplete(true)"
echo "     ‚îî‚îÄ Muestra pantalla de √âXITO con:"
echo "        ‚îú‚îÄ ‚úÖ CheckCircleIcon (verde)"
echo "        ‚îú‚îÄ 'Solicitud enviada con √©xito'"
echo "        ‚îú‚îÄ 'Hemos recibido tu solicitud'"
echo "        ‚îî‚îÄ Bot√≥n 'Volver al inicio'"
echo ""
echo "  B. Si response.error (status 4xx/5xx):"
echo "     ‚îî‚îÄ setApiError(data.error)"
echo "     ‚îî‚îÄ Muestra alerta roja con error espec√≠fico"
echo ""
echo "  C. Si timeout (60 segundos):"
echo "     ‚îî‚îÄ Considera como √âXITO (porque n8n probablemente ya envi√≥)"
echo "     ‚îî‚îÄ setSubmissionComplete(true)"
echo "     ‚îî‚îÄ Muestra pantalla de √©xito"
echo ""

echo "üìã TEST 5: Verificar timeout handling"
echo "-------------------------------------------"
echo "‚è±Ô∏è  TIMEOUT DETECTADO:"
echo "  - Fetch con signal controller"
echo "  - Timeout: 60 segundos"
echo "  - N8N t√≠picamente tarda: 5-30s"
echo ""
echo "‚úÖ SI OCURRE TIMEOUT:"
echo "  - error.name === 'AbortError'"
echo "  - setSubmissionComplete(true)  ‚Üê Mostrar √©xito"
echo "  - Porque:"
echo "    ‚îî‚îÄ Backend ya retorn√≥ 'ok'"
echo "    ‚îî‚îÄ N8N ya proces√≥ el webhook"
echo "    ‚îî‚îÄ Solo el fetch se abort√≥ por timeout"
echo ""

echo "=========================================="
echo "FLUJO COMPLETO VERIFICADO ‚úÖ"
echo "=========================================="
echo ""

echo "üìä PUNTOS DE VERIFICACI√ìN EN PRODUCCI√ìN:"
echo ""
echo "1. BACKEND:"
echo "   railway logs | grep 'Enviando a N8N'"
echo "   Debe mostrar: Email enviado, WhatsApp enviado"
echo ""
echo "2. N8N LOGS:"
echo "   Ver ejecuci√≥n de webhook en N8N dashboard"
echo "   Debe mostrar: Success, registros creados"
echo ""
echo "3. FRONTEND:"
echo "   Consola del navegador (F12 ‚Üí Console)"
echo "   Debe mostrar:"
echo "   - '‚úÖ Respuesta exitosa: {...}'"
echo "   - 'Pantalla de √©xito mostrada'"
echo ""
echo "4. USUARIO FINAL:"
echo "   - Ve pantalla de √©xito en repogemin"
echo "   - Recibe email de confirmaci√≥n"
echo "   - Recibe WhatsApp de confirmaci√≥n"
echo ""

